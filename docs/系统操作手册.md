# 系统操作手册（M-WMS 后端）

> 适用范围：本文档基于当前后端代码的 Controller/DTO 逻辑整理（以全局 JWT 守卫 + @Public 标注为准），用于指导前端/联调/运营按实际接口完成业务操作。

## 1. 基础信息

- **API 前缀**：`/api`（可通过环境变量 `API_PREFIX` 调整）
- **Swagger**：`/api-docs`
- **响应结构**：全局拦截器统一返回 `{ code, message, data }`，HTTP 状态码固定为 200
- **认证方式**：默认所有接口需要 JWT（全局守卫），标注 `@Public()` 的接口无需登录
- **租户隔离**：租户 ID 从 JWT 中解析（`req.user.tenantId`），大部分接口不需要手动传 `tenantId`

## 2. 快速上手流程（SaaS 入驻 -> 登录）

1. **发送短信验证码**
   - `GET /api/send/sendSMS?phone=手机号`
2. **租户入驻**（公开接口）
   - `POST /api/tenants/onboard`
   - 成功后返回 `tenantId / adminId / username` 等信息
3. **登录获取 Token**
   - `POST /api/auth/login`
   - 成功后返回 JWT（用于后续鉴权）
4. **调用业务接口**
   - Header：`Authorization: Bearer <JWT>`

## 3. 通用约定

- **Content-Type**：JSON 接口使用 `application/json`
- **分页参数**：`page / pageSize`（接口若支持分页）
- **常用下拉选择接口**：
  - 产品：`GET /api/products/select`
  - 库位：`GET /api/locations/available-for-selection`
  - 角色：`POST /api/roles/selectRoleLists`
  - 字典：`GET /api/dicts/options?type=...`

## 4. 模块操作说明

### 4.1 租户管理（SaaS）

- **入驻**（公开）
  - `POST /api/tenants/onboard`
- **分页列表**
  - `POST /api/tenants/list`
- **详情**
  - `POST /api/tenants/detail`
- **修改**
  - `PATCH /api/tenants/:id`
- **删除**
  - `DELETE /api/tenants/:id`

### 4.2 认证与账号

- **登录**（公开）
  - `POST /api/auth/login`
- **注册（需要登录）**
  - `POST /api/auth/register`

### 4.3 用户管理

- **当前用户信息**
  - `GET /api/users/getUserInfo`
- **员工分页列表**
  - `GET /api/users/page`
- **新增员工**
  - `POST /api/users/save`
- **更新员工**
  - `POST /api/users/update`
- **个人修改密码**
  - `POST /api/users/password`
- **管理员重置密码**
  - `POST /api/users/reset`
- **员工状态切换**
  - `POST /api/users/status`
- **删除员工**
  - `POST /api/users/delete`
- **员工详情**
  - `POST /api/users/detail`

### 4.4 角色管理

- **创建角色**
  - `POST /api/roles`
- **角色分页列表**
  - `GET /api/roles`
- **角色详情**
  - `GET /api/roles/:id`
- **更新角色**
  - `POST /api/roles/:id/update`
- **删除角色**
  - `DELETE /api/roles/:id`
- **启用/禁用**
  - `POST /api/roles/:id/status`
- **全部启用角色（下拉）**
  - `POST /api/roles/selectRoleLists`

### 4.5 单位管理

- **创建单位**
  - `POST /api/units/save`
- **更新单位**
  - `POST /api/units/update`
- **单位列表**
  - `GET /api/units`
- **启用单位列表**
  - `GET /api/units/active`
- **分页列表**
  - `GET /api/units/page`
- **详情（按 id 或 code）**
  - `POST /api/units/detail`
- **删除**
  - `POST /api/units/delete`

**关键字段（CreateUnitDto）**：
- `name` 单位名称
- `code` 单位编码（可选）
- `category` 单位分类（COUNT / WEIGHT / LENGTH / VOLUME / AREA / TIME）
- `baseRatio` 基本换算倍率（> 0）
- `baseUnitCode` 基本单位编码
- `symbol` / `description` / `isActive` / `sortOrder`（可选）

### 4.6 库位管理

- **创建库位**
  - `POST /api/locations`
- **批量创建库位**（预留）
  - `POST /api/locations/batch`
- **库位列表**
  - `GET /api/locations`
- **可选库位（下拉）**
  - `GET /api/locations/available-for-selection`
- **库位详情**
  - `GET /api/locations/:id`
- **按编码查询**
  - `GET /api/locations/code/:code`
- **更新库位**
  - `PUT /api/locations/:id`
- **删除库位**
  - `DELETE /api/locations/:id`

### 4.7 产品管理

**类目（Categories）**
- `POST /api/categories/save`
- `GET /api/categories/page`
- `GET /api/categories/detail`
- `POST /api/categories/status`
- `POST /api/categories/update`
- `POST /api/categories/delete`

**属性（Attributes）**
- `GET /api/attributes/page`
- `POST /api/attributes/save`
- `POST /api/attributes/update`
- `GET /api/attributes/detail`
- `POST /api/attributes/delete`
- `POST /api/attributes/batchDelete`
- `POST /api/attributes/status`
- `GET /api/attributes/template`（下载导入模板）
- `POST /api/attributes/import`（导入）

**规格值（Options）**
- `GET /api/options/page`
- `POST /api/options/save`
- `POST /api/options/update`
- `GET /api/options/detail`
- `POST /api/options/delete`
- `POST /api/options/batchDelete`
- `POST /api/options/status`

**产品（Products）**
- `GET /api/products/select`
- `POST /api/products/save`
- `POST /api/products/update`
- `GET /api/products/page`
- `GET /api/products/detail`
- `POST /api/products/status`
- `POST /api/products/delete`
- `GET /api/products/template`（下载导入模板）
- `POST /api/products/import`（导入）

### 4.8 库存管理

**库存与告警**
- 库存列表：`GET /api/inventory`
- 库存分页：`GET /api/inventory/page`
- 库存详情：`GET /api/inventory/:id`
- 低库存告警：`GET /api/inventory/alerts`

**库存流水**
- 流水分页：`GET /api/inventory/transactions`
- 指定 SKU 流水：`GET /api/inventory/:sku/transactions`

**入库**
- 入库流水列表：`GET /api/inventory/inbound`
- 单笔入库：`POST /api/inventory/inbound`
- 批量入库：`POST /api/inventory/inbound/batch`

**出库**
- 出库流水列表：`GET /api/inventory/outbound`
- 单笔出库：`POST /api/inventory/outbound`
- 批量出库：`POST /api/inventory/outbound/batch`

**库存调整**
- `POST /api/inventory/adjust`

**库存交易类型（TransactionType）**：
- 入库：`INBOUND_PURCHASE / INBOUND_RETURN / INBOUND_TRANSFER / INBOUND_PRODUCTION`
- 出库：`OUTBOUND_SALES / OUTBOUND_MATERIAL / OUTBOUND_TRANSFER / OUTBOUND_SCRAP`
- 调整：`ADJUSTMENT_IN / ADJUSTMENT_OUT`

### 4.9 订单管理

- 创建订单：`POST /api/orders`
- 订单列表：`GET /api/orders`
- 订单详情：`GET /api/orders/:id`
- 更新订单：`PATCH /api/orders/:id`
- 删除订单：`DELETE /api/orders/:id`

### 4.10 系统字典

- 字典选项（公开）：`GET /api/dicts/options?type=...`
- 新增：`POST /api/dicts/save`
- 更新：`POST /api/dicts/update`
- 删除：`POST /api/dicts/delete`

### 4.11 门户网站

**对外门户（公开）**
- 初始化数据：`GET /api/portal/:domain/init`
- 产品详情：`GET /api/portal/:domain/products/:id`
- 访客询盘：`POST /api/portal/:domain/inquiry`

**管理后台（需要登录）**
- 获取配置：`GET /api/portal/config`
- 更新配置：`PATCH /api/portal/config`
- 询盘列表：`GET /api/portal/inquiries`

### 4.12 上传

- 多文件上传（公开）：`POST /api/upload/fileList`
  - `multipart/form-data`
  - 字段名：`file`（数组）
  - 最大 6 个文件
  - 上传路径：`src/uploadsImg/`

### 4.13 健康检查

- `GET /api/health`
  - 默认受全局 JWT 保护，如需公开可为该接口添加 `@Public()`

## 5. 导入/模板使用说明

- **属性导入**
  1. 下载模板：`GET /api/attributes/template`
  2. 填写模板并导入：`POST /api/attributes/import`（`multipart/form-data`）

- **产品导入**
  1. 下载模板：`GET /api/products/template`
     - 可传 `categoryCode`，按类目生成带属性列的模板
  2. 填写模板并导入：`POST /api/products/import`（`multipart/form-data`）

## 6. 常见问题排查

- **401 未授权**：检查是否携带 `Authorization: Bearer <JWT>`
- **租户数据为空**：确认登录账号所属租户是否正确
- **导入失败**：接口可能返回业务异常并给出成功/失败条数与错误列表

